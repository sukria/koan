{% extends "wizard/base.html" %}
{% set step = 2 %}

{% block title %}Telegram Setup - K≈çan Setup{% endblock %}
{% block subtitle %}Connect to Telegram{% endblock %}

{% block content %}
<div class="wizard-card">
    <h2>Create a Telegram Bot</h2>
    <p>K≈çan uses Telegram as its communication channel. You'll need to create a bot.</p>

    <div class="alert alert-info" style="margin-top: 1rem;">
        <span>üí°</span>
        <div>
            <strong>Quick guide:</strong><br>
            1. Open Telegram and message <a href="https://t.me/BotFather" target="_blank" style="color: var(--accent)">@BotFather</a><br>
            2. Send <code class="code-inline">/newbot</code> and follow the prompts<br>
            3. Copy the API token you receive
        </div>
    </div>
</div>

<div class="wizard-card">
    <h2>Bot Token</h2>

    <div class="form-group">
        <label class="form-label">Telegram Bot Token</label>
        <input type="text" id="token-input" class="form-input"
               placeholder="1234567890:ABCdefGHIjklMNOpqrSTUvwxYZ"
               value="{{ display_token }}"
               autocomplete="off">
        <div class="form-hint">From @BotFather after creating your bot</div>
    </div>

    <div id="token-status" class="hidden"></div>

    <div class="btn-row">
        <button id="btn-verify-token" class="btn btn-secondary" onclick="verifyToken()">
            Verify Token
        </button>
    </div>
</div>

<div id="chat-id-section" class="wizard-card hidden fade-in">
    <h2>Chat ID</h2>
    <p>Your personal chat ID so the bot knows who to talk to.</p>

    <div class="form-group">
        <label class="form-label">Chat ID</label>
        <input type="text" id="chatid-input" class="form-input"
               placeholder="123456789"
               value="{{ current_chat_id }}"
               autocomplete="off">
        <div id="chatid-hint" class="form-hint">
            Send any message to your bot first, then click "Detect Chat ID"
        </div>
    </div>

    <div class="btn-row">
        <button id="btn-detect-chatid" class="btn btn-secondary" onclick="detectChatId()">
            Detect Chat ID
        </button>
    </div>
</div>

<div class="btn-row between">
    <a href="/step/welcome" class="btn btn-secondary">‚Üê Back</a>
    <button id="btn-continue" class="btn btn-primary" onclick="saveAndContinue()" disabled>
        Continue ‚Üí
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
let verifiedToken = null;

async function verifyToken() {
    const tokenInput = document.getElementById('token-input');
    const statusDiv = document.getElementById('token-status');
    const chatIdSection = document.getElementById('chat-id-section');
    const btn = document.getElementById('btn-verify-token');

    const token = tokenInput.value.trim();
    if (!token) {
        showStatus(statusDiv, 'error', 'Please enter a token');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Verifying...';

    try {
        const response = await fetch('/step/telegram/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
        });
        const data = await response.json();

        if (data.valid) {
            verifiedToken = token;
            tokenInput.classList.remove('invalid');
            tokenInput.classList.add('valid');
            showStatus(statusDiv, 'success', `Bot verified: @${data.username}`);
            chatIdSection.classList.remove('hidden');

            // If we got a chat_id from updates, pre-fill it
            if (data.chat_id) {
                document.getElementById('chatid-input').value = data.chat_id;
                document.getElementById('chatid-input').classList.add('valid');
                document.getElementById('chatid-hint').textContent = 'Auto-detected from your messages!';
                updateContinueButton();
            }
        } else {
            tokenInput.classList.remove('valid');
            tokenInput.classList.add('invalid');
            showStatus(statusDiv, 'error', 'Invalid token: ' + (data.error || 'Unknown error'));
            verifiedToken = null;
        }
    } catch (e) {
        showStatus(statusDiv, 'error', 'Error: ' + e.message);
    }

    btn.disabled = false;
    btn.innerHTML = 'Verify Token';
}

async function detectChatId() {
    if (!verifiedToken) {
        alert('Please verify your token first');
        return;
    }

    const btn = document.getElementById('btn-detect-chatid');
    const chatIdInput = document.getElementById('chatid-input');
    const hint = document.getElementById('chatid-hint');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Detecting...';

    try {
        const response = await fetch('/step/telegram/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: verifiedToken })
        });
        const data = await response.json();

        if (data.chat_id) {
            chatIdInput.value = data.chat_id;
            chatIdInput.classList.add('valid');
            hint.textContent = 'Detected successfully!';
            hint.style.color = 'var(--green)';
            updateContinueButton();
        } else {
            hint.textContent = 'No messages found. Send a message to your bot and try again.';
            hint.style.color = 'var(--orange)';
        }
    } catch (e) {
        hint.textContent = 'Error: ' + e.message;
        hint.style.color = 'var(--red)';
    }

    btn.disabled = false;
    btn.innerHTML = 'Detect Chat ID';
}

function showStatus(element, type, message) {
    element.classList.remove('hidden');
    element.className = `alert alert-${type === 'success' ? 'success' : 'error'} fade-in`;
    element.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚úó'}</span><div>${message}</div>`;
}

function updateContinueButton() {
    const tokenInput = document.getElementById('token-input');
    const chatIdInput = document.getElementById('chatid-input');
    const continueBtn = document.getElementById('btn-continue');

    const hasToken = verifiedToken && tokenInput.value.trim();
    const hasChatId = chatIdInput.value.trim() && /^\d+$/.test(chatIdInput.value.trim());

    continueBtn.disabled = !(hasToken && hasChatId);
}

async function saveAndContinue() {
    const token = document.getElementById('token-input').value.trim();
    const chatId = document.getElementById('chatid-input').value.trim();

    if (!token || !chatId) {
        alert('Please complete both token and chat ID');
        return;
    }

    const btn = document.getElementById('btn-continue');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Saving...';

    try {
        const response = await fetch('/step/telegram/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, chat_id: chatId })
        });
        const data = await response.json();

        if (data.ok) {
            window.location.href = '/step/projects';
        } else {
            alert('Failed to save: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = 'Continue ‚Üí';
        }
    } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = 'Continue ‚Üí';
    }
}

// Update continue button when chat ID changes
document.getElementById('chatid-input').addEventListener('input', updateContinueButton);

// Check if we already have valid values
{% if display_token %}
verifiedToken = '{{ display_token }}'; // Placeholder, will re-verify
document.getElementById('chat-id-section').classList.remove('hidden');
{% endif %}
{% if current_chat_id %}
updateContinueButton();
{% endif %}
</script>
{% endblock %}
