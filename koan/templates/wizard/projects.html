{% extends "wizard/base.html" %}
{% set step = 3 %}

{% block title %}Projects - Kōan Setup{% endblock %}
{% block subtitle %}Configure your projects{% endblock %}

{% block content %}
<div class="wizard-card">
    <h2>Add Projects</h2>
    <p>
        Tell Kōan which codebases to work on. You can add up to 5 projects.
        Each project needs a name and a path to the repository root.
    </p>

    <div id="project-list" class="project-list">
        {% for project in projects %}
        <div class="project-item" data-index="{{ loop.index0 }}">
            <input type="text" class="form-input project-name" placeholder="Name" value="{{ project.name }}" style="width: 100px; flex: 0;">
            <input type="text" class="form-input project-path" placeholder="/path/to/project" value="{{ project.path }}" style="flex: 1;">
            <div class="actions">
                <button class="btn btn-secondary btn-icon" onclick="validateProject(this)" title="Validate">✓</button>
                <button class="btn btn-secondary btn-icon" onclick="removeProject(this)" title="Remove">✗</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="add-project-form" class="project-item" style="border-style: dashed; border-color: var(--border);">
        <input type="text" id="new-project-name" class="form-input project-name" placeholder="Name" style="width: 100px; flex: 0;">
        <input type="text" id="new-project-path" class="form-input project-path" placeholder="/path/to/project" style="flex: 1;">
        <div class="actions">
            <button class="btn btn-primary btn-icon" onclick="addProject()" title="Add">+</button>
        </div>
    </div>

    <div id="validation-status" class="hidden" style="margin-top: 1rem;"></div>
</div>

<div class="wizard-card">
    <h2>Tips</h2>
    <ul style="color: var(--text-muted); padding-left: 1.25rem;">
        <li>Projects should have a <code class="code-inline">CLAUDE.md</code> file for best results</li>
        <li>Kōan creates its own <code class="code-inline">koan/*</code> branches — your main branch stays untouched</li>
        <li>Use <code class="code-inline">~</code> for home directory (e.g., <code class="code-inline">~/Projects/myapp</code>)</li>
    </ul>
</div>

<div class="btn-row between">
    <a href="/step/telegram" class="btn btn-secondary">← Back</a>
    <button id="btn-continue" class="btn btn-primary" onclick="saveAndContinue()" disabled>
        Continue →
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
let validatedProjects = new Set();

function getProjects() {
    const items = document.querySelectorAll('#project-list .project-item');
    const projects = [];
    items.forEach(item => {
        const name = item.querySelector('.project-name').value.trim();
        const path = item.querySelector('.project-path').value.trim();
        if (name && path) {
            projects.push({ name, path });
        }
    });
    return projects;
}

function updateContinueButton() {
    const projects = getProjects();
    const btn = document.getElementById('btn-continue');
    btn.disabled = projects.length === 0 || validatedProjects.size === 0;
}

async function validateProject(button) {
    const item = button.closest('.project-item');
    const nameInput = item.querySelector('.project-name');
    const pathInput = item.querySelector('.project-path');
    const statusDiv = document.getElementById('validation-status');

    const path = pathInput.value.trim();
    if (!path) {
        showValidationStatus('error', 'Please enter a path');
        return;
    }

    button.disabled = true;
    button.innerHTML = '<span class="spinner" style="width:14px;height:14px;"></span>';

    try {
        const response = await fetch('/step/projects/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
        });
        const data = await response.json();

        if (data.valid) {
            pathInput.classList.remove('invalid');
            pathInput.classList.add('valid');
            pathInput.value = data.absolute_path; // Use absolute path

            // Auto-fill name if empty
            if (!nameInput.value.trim()) {
                const parts = data.absolute_path.split('/');
                nameInput.value = parts[parts.length - 1];
            }

            let msg = `✓ Valid project at <code class="code-inline">${data.absolute_path}</code>`;
            if (data.has_claude_md) {
                msg += ' <span class="tag tag-green">CLAUDE.md</span>';
            }
            if (data.is_git_repo) {
                msg += ' <span class="tag tag-green">Git</span>';
            }
            showValidationStatus('success', msg);

            validatedProjects.add(data.absolute_path);
            updateContinueButton();
        } else {
            pathInput.classList.remove('valid');
            pathInput.classList.add('invalid');
            showValidationStatus('error', data.error || 'Invalid path');
            validatedProjects.delete(path);
        }
    } catch (e) {
        showValidationStatus('error', 'Error: ' + e.message);
    }

    button.disabled = false;
    button.innerHTML = '✓';
}

function addProject() {
    const nameInput = document.getElementById('new-project-name');
    const pathInput = document.getElementById('new-project-path');

    const name = nameInput.value.trim();
    const path = pathInput.value.trim();

    if (!path) {
        document.getElementById('new-project-path').focus();
        return;
    }

    const list = document.getElementById('project-list');
    const index = list.children.length;

    const item = document.createElement('div');
    item.className = 'project-item fade-in';
    item.dataset.index = index;
    item.innerHTML = `
        <input type="text" class="form-input project-name" placeholder="Name" value="${name}" style="width: 100px; flex: 0;">
        <input type="text" class="form-input project-path" placeholder="/path/to/project" value="${path}" style="flex: 1;">
        <div class="actions">
            <button class="btn btn-secondary btn-icon" onclick="validateProject(this)" title="Validate">✓</button>
            <button class="btn btn-secondary btn-icon" onclick="removeProject(this)" title="Remove">✗</button>
        </div>
    `;
    list.appendChild(item);

    // Clear the add form
    nameInput.value = '';
    pathInput.value = '';

    // Validate the new project
    validateProject(item.querySelector('.actions button:first-child'));
}

function removeProject(button) {
    const item = button.closest('.project-item');
    const path = item.querySelector('.project-path').value;
    validatedProjects.delete(path);
    item.remove();
    updateContinueButton();
}

function showValidationStatus(type, message) {
    const statusDiv = document.getElementById('validation-status');
    statusDiv.classList.remove('hidden');
    statusDiv.className = `alert alert-${type === 'success' ? 'success' : 'error'} fade-in`;
    statusDiv.innerHTML = `<span>${type === 'success' ? '✓' : '✗'}</span><div>${message}</div>`;
}

async function saveAndContinue() {
    const projects = getProjects();

    if (projects.length === 0) {
        alert('Please add at least one project');
        return;
    }

    const btn = document.getElementById('btn-continue');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Saving...';

    try {
        const response = await fetch('/step/projects/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ projects })
        });
        const data = await response.json();

        if (data.ok) {
            window.location.href = '/step/ready';
        } else {
            alert('Failed to save: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = 'Continue →';
        }
    } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = 'Continue →';
    }
}

// Allow Enter key to add project
document.getElementById('new-project-path').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addProject();
    }
});

// Check initial state
{% if projects %}
{% for project in projects %}
validatedProjects.add('{{ project.path }}');
{% endfor %}
updateContinueButton();
{% endif %}
</script>
{% endblock %}
