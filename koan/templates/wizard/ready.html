{% extends "wizard/base.html" %}
{% set step = 4 %}

{% block title %}Ready! - K≈çan Setup{% endblock %}
{% block subtitle %}You're all set{% endblock %}

{% block content %}
<div class="wizard-card">
    <h2>Configuration Summary</h2>

    <ul class="check-list">
        <li class="check-item">
            <span class="check-icon {% if status.instance_exists %}success{% else %}error{% endif %}">
                {% if status.instance_exists %}‚úì{% else %}‚úó{% endif %}
            </span>
            <span class="check-text">Instance directory</span>
        </li>
        <li class="check-item">
            <span class="check-icon {% if status.telegram_configured %}success{% else %}error{% endif %}">
                {% if status.telegram_configured %}‚úì{% else %}‚úó{% endif %}
            </span>
            <span class="check-text">Telegram configured</span>
        </li>
        <li class="check-item">
            <span class="check-icon {% if status.projects_configured %}success{% else %}error{% endif %}">
                {% if status.projects_configured %}‚úì{% else %}‚úó{% endif %}
            </span>
            <span class="check-text">
                Projects configured
                {% if projects %}
                <div class="form-hint" style="margin-top: 0.25rem;">
                    {% for p in projects %}
                    <span class="tag tag-green">{{ p.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </span>
        </li>
        <li class="check-item">
            <span class="check-icon {% if status.venv_exists %}success{% else %}pending{% endif %}">
                {% if status.venv_exists %}‚úì{% else %}‚óã{% endif %}
            </span>
            <span class="check-text">
                Python dependencies
                {% if not status.venv_exists %}
                <div class="form-hint">Click "Install Dependencies" below</div>
                {% endif %}
            </span>
        </li>
    </ul>
</div>

{% if not status.venv_exists %}
<div class="wizard-card">
    <h2>Install Dependencies</h2>
    <p>One last step ‚Äî we need to install the Python packages.</p>

    <div id="setup-status" class="hidden"></div>

    <div class="btn-row">
        <button id="btn-install" class="btn btn-primary" onclick="runSetup()">
            Install Dependencies
        </button>
    </div>
</div>
{% endif %}

<div class="wizard-card" id="launch-section" {% if not status.venv_exists %}style="opacity: 0.5; pointer-events: none;"{% endif %}>
    <h2>Launch K≈çan</h2>
    <p>Open two terminal windows and run:</p>

    <div style="display: grid; gap: 1rem; margin: 1rem 0;">
        <div>
            <div class="form-label">Terminal 1 ‚Äî Telegram Bridge</div>
            <div class="code-block">make awake</div>
        </div>
        <div>
            <div class="form-label">Terminal 2 ‚Äî Agent Loop</div>
            <div class="code-block">make run</div>
        </div>
    </div>

    <div class="alert alert-info">
        <span>üí°</span>
        <div>
            <strong>First interaction:</strong> Send a message to your Telegram bot!
            Try: <code class="code-inline">Hello K≈çan</code>
        </div>
    </div>
</div>

<div class="wizard-card" style="text-align: center; border-color: var(--green); background: var(--green-bg);">
    <h2 style="color: var(--green);">Setup Complete!</h2>
    <p>
        K≈çan is ready to assist. Close this wizard and start the agent.
    </p>
    <p style="margin-top: 1rem; font-family: var(--mono); color: var(--text-muted);">
        The agent proposes. The human decides.
    </p>
</div>

<div class="btn-row between">
    <a href="/step/projects" class="btn btn-secondary">‚Üê Back</a>
    <button class="btn btn-success" onclick="window.close(); return false;">
        Close Wizard
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
async function runSetup() {
    const btn = document.getElementById('btn-install');
    const statusDiv = document.getElementById('setup-status');
    const launchSection = document.getElementById('launch-section');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Installing... (this may take a minute)';
    statusDiv.classList.remove('hidden');
    statusDiv.className = 'alert alert-info fade-in';
    statusDiv.innerHTML = '<span class="spinner"></span> <div>Running <code class="code-inline">make setup</code>...</div>';

    try {
        const response = await fetch('/step/ready/setup', { method: 'POST' });
        const data = await response.json();

        if (data.ok) {
            statusDiv.className = 'alert alert-success fade-in';
            statusDiv.innerHTML = '<span>‚úì</span><div><strong>Dependencies installed!</strong></div>';
            btn.innerHTML = '‚úì Installed';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');

            // Enable launch section
            launchSection.style.opacity = '1';
            launchSection.style.pointerEvents = 'auto';
        } else {
            statusDiv.className = 'alert alert-error fade-in';
            statusDiv.innerHTML = `<span>‚úó</span><div><strong>Installation failed</strong><br><pre style="margin-top:0.5rem;max-height:200px;overflow:auto;">${data.output || 'Unknown error'}</pre></div>`;
            btn.disabled = false;
            btn.innerHTML = 'Retry Installation';
        }
    } catch (e) {
        statusDiv.className = 'alert alert-error fade-in';
        statusDiv.innerHTML = `<span>‚úó</span><div>Error: ${e.message}</div>`;
        btn.disabled = false;
        btn.innerHTML = 'Retry Installation';
    }
}
</script>
{% endblock %}
