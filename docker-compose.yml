# Kōan Docker Compose
#
# Claude CLI is installed in the image. Auth is via ANTHROPIC_API_KEY in .env.
# Run ./setup-docker.sh first — it generates docker-compose.override.yml
# with workspace mounts and GitHub CLI auth for your system.
#
# REQUIRED: Set ANTHROPIC_API_KEY in .env
# Get one at: https://console.anthropic.com/settings/keys
#
# Usage:
#   ./setup-docker.sh               # Auto-detect host setup
#   docker compose up --build        # Full stack (agent + bridge)
#   docker compose run koan test     # Run test suite
#   docker compose run koan shell    # Interactive shell

services:
  koan:
    build:
      context: .
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    container_name: koan
    env_file:
      - .env
    environment:
      - KOAN_ROOT=/app
      - PYTHONPATH=/app/koan
    volumes:
      # Instance state — persisted across restarts
      - ./instance:/app/instance
      # Isolated mission queue for Docker (overlays instance/ mount)
      - ./instance/missions.docker.md:/app/instance/missions.md
      # Workspace — host project repos (read-write)
      - ./workspace:/app/workspace
      # Logs
      - ./logs:/app/logs
    restart: unless-stopped
    # No ports exposed by default — Telegram/Slack only
    # Uncomment to expose dashboard:
    # ports:
    #   - "5001:5001"
